<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="msapplication-TileColor" content="#FFFFFF">
        <meta name="msapplication-TileImage" content="/img/acticon_144x144.png">
        <title>Achernar Overlay :: Project Laniakea</title>
        <script src="/js/lib.js"></script>
        <link rel="shortcut icon" href="favicon.ico">
        <link rel="icon" href="/img/acticon_16x16.png" sizes="16x16">
        <link rel="icon" href="/img/acticon_32x32.png" sizes="32x32">
        <link rel="icon" href="/img/acticon_48x48.png" sizes="48x48">
        <link rel="icon" href="/img/acticon_57x57.png" sizes="57x57">
        <link rel="icon" href="/img/acticon_64x64.png" sizes="64x64">
        <link rel="icon" href="/img/acticon_72x72.png" sizes="72x72">
        <link rel="icon" href="/img/acticon_96x96.png" sizes="96x96">
        <link rel="icon" href="/img/acticon_114x114.png" sizes="114x114">
        <link rel="icon" href="/img/acticon_120x120.png" sizes="120x120">
        <link rel="icon" href="/img/acticon_144x144.png" sizes="144x144">
        <link rel="icon" href="/img/acticon_152x152.png" sizes="152x152">
        <link rel="icon" href="/img/acticon_195x195.png" sizes="195x195">
        <link rel="icon" href="/img/acticon_228x228.png" sizes="228x228">
        <link rel="icon" href="/img/acticon.png" sizes="256x256">
        <link rel="apple-touch-icon-precomposed" href="/img/acticon_152x152.png">
        <link rel="stylesheet" href="./css/xivicon/xivicons.css">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;300;400;500;700;900&family=Noto+Sans+KR:wght@100;300;400;500;700;900&family=Noto+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="./css/default.css">
        <script>
            class FWebSocket
            {
                constructor(uri)
                {
                    this.uri = uri;
                    this.url = uri;
                    this.id  = null;
                    this.activate = false;
                    let self = this;
                    document.addEventListener('onBroadcastMessage', function( callback )
                    {
                        self.onBroadcastMessage(callback);
                    });
                    document.addEventListener('onRecvMessage', function( callback )
                    {
                        self.onRecvMessage(callback);
                    });
                    window.addEventListener('message', function(e)
                    {
                        if (e.data.type === 'onBroadcastMessage') self.onBroadcastMessage( e.data );
                    });
                    window.addEventListener("unload", function()
                    {
                        self.close();
                    }, false);
                    this.connect();
                }
                connect()
                {
                    let self = this;
                    if (typeof this.ws != "undefined" && this.ws != null) this.close();
                    this.activate = true;
                    var url_string = window.location.href;
                    var url = new URL(url_string);
                    var c = url.searchParams.get("HOST_PORT");
                    console.log(c);
                    if (c)
                    {
                        if (window.location.href.indexOf("fake") > -1)
                        {
                            this.uri = c;
                        }
                        else this.uri = this.uri.replace("localhost:20000", c);
                    }
                    this.ws = new WebSocket(this.uri);
                    this.ws.onopen = function(event) { self.onopen(event); }
                    this.ws.onmessage = function(event) { self.onmessage(event); }
                    this.ws.onclose = function(event) { self.onclose(event); }
                    this.ws.onerror = function(event) { self.onerror(event); }
                }
                close()
                {
                    this.activate = false;
                    if (typeof this.ws != "undefined" && this.ws != null) this.ws.close();
                }
                onopen(event) { }
                onclose(event)
                {
                    this.ws = null;
                    if (this.activate)
                    {
                        let self = this;
                        setTimeout(function() {self.connect(); }, 2000);
                    }
                }
                onmessage(event) { }
                onerror(event)
                {
                    console.log(event);
                }
                send(data) { this.ws.send(data); }
                onRecvMessage(data) { }
                onBroadcastMessage(data) { }
            }
        </script>
    </head>
    <body>
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="1" height="1" style="position:absolute;">
            <clippath id="header_path"></clippath>
        </svg>
        <div class="resizer"></div>
        <div class="background-layer"></div>
        <div class="header">
            <section class="left">
                <section class="timer">
                    <section class="hour-a" style="display:none"></section>
                    <section class="hour sep" style="display:none"></section>
                    <section class="min-a"></section>
                    <section class="min-b"></section>
                    <section class="sep"></section>
                    <section class="sec-a"></section>
                    <section class="sec-b"></section>
                </section>
                <div class="titlename">
                    <div class="title"></div>
                    <div class="partydata">
                        <span class="pdps"></span>
                        <span class="phps"></span>
                    </div>
                </div>
            </section>
            <section class="right">
                <div class="menubtn"></div>
            </section>
        </div>
        <div class="main-list-area"></div>
        <script>
            /*
             * Achernar Overlay Base Script
             * Developed by LalaNET and other contributors
             * License: GPLv3
            */

            // code from MDN
            let optRS = (function()
            {
                let callbacks = [], running = false;
                function resize()
                {
                    if (!running)
                    {
                        running = true;
                        if (window.requestAnimationFrame) window.requestAnimationFrame(runCallbacks);
                        else setTimeout(runCallbacks, 66);
                    }
                }

                function runCallbacks()
                {
                    callbacks.forEach(function(callback){callback();});
                    running = false;
                }
                
                function addCallback(callback)
                {
                    if (callback) callbacks.push(callback);
                }

                return {
                    add: function(callback)
                    {
                        if (!callbacks.length)
                        {
                            window.addEventListener('resize', resize);
                        }
                        addCallback(callback);
                    }
                }
            }());

            const 
                defaultsvg = "0,8 8,0 $A,0 $B,8 $B,$C $A,$D 8,$D 0,$C 0,8",
                headersvg = "0,0 $B,0 $B,$C $A,$D 8,$D 0,$C 0,0",
                timedisplay = ["hour-a", "min-a", "min-b", "sec-a", "sec-b"],
                healer = ["Cnj", "Whm", "Sch", "Ast"],
                tanker = ["Gla", "Gld", "Mrd", "Pld", "War", "Drk", "Gnb"],
                intValues = ["DURATION","DPS","DPS-k","DPS-m","ENCDPS","ENCDPS-k","ENCDPS-m","ENCHPS","ENCHPS-k","ENCHPS-m","DAMAGE-b","DAMAGE-k","DAMAGE-m","CritDirectHitCount","DirectHitCount","MAXHIT","MAXHEAL","TOHIT","crithits","absorbHeal","critheals","damage","damageShield","damagetaken","deaths","healed","heals","healstaken","hitfailed","hits","kills","cures","misses","overHeal","powerdrain","powerheal","swings","threatdelta"],
                floatValues = ["damage-b","damage-k","damage-m","dps","encdps","enchps","tohit","Last10DPS","Last30DPS","Last60DPS","Last180DPS"],
                percentValues = ["BlockPct","CritDirectHitPct","DirectHitPct","OverHealPct","ParryPct","crithit%","damage%"],
                f = new FWebSocket("ws://localhost:20000/MiniParse");

            const ffxiv = function(raw)
                {
                    this.data = {};
                    if (raw == "." || !raw) this.data = {"type": "pinging", "msgtype": "ping"};
                    try
                    {
                        let data = JSON.parse(raw, (k,v) =>
                        {
                            if (intValues.filter(x => x == k).length > 0) return v == "0" ? 0 : (isNaN(parseInt(v)) ? 0 : parseInt(v));
                            else if (floatValues.filter(x => x == k).length > 0) return (v == "0" || v == "0.00") ? 0 : (isNaN(parseFloat(v)) ? 0 : parseFloat(v));
                            else if (percentValues.filter(x => x == k).length > 0) return (v == "0" ? 0 : parseInt(v)) * 0.01;
                            else return v;
                        });
                        this.data = data;
                    }
                    catch (err) { this.data = {"type": "processError", "msgtype": "error", "msg": err}; }

                    this.getJSON = function()
                    {
                        return JSON.stringify(this.data);
                    }

                    return this.data;
                };
            f.onmessage = (e) => { dataProcess(new ffxiv(e.data)); }

            function redrawHeader(elem, svg = defaultsvg)
            {
                let width = elem.clientWidth;
                let height = elem.clientHeight;
                let w_a = width - 8;
                let w_c = height - 8;
                let svg_line = svg.replace(/\$A/ig, w_a).replace(/\$B/ig, width).replace(/\$C/ig, w_c).replace(/\$D/ig, height);
                let poly = document.createElementNS('http://www.w3.org/2000/svg', "polygon");
                poly.setAttribute("points", svg_line);
                document.querySelector("#header_path").innerHTML = "";
                document.querySelector("#header_path").append(poly);
            }

            let lastData = null;
            let sortkey = "encdps";
            let sortkeyperc = "damage%";
            let tick = 0;
            let ticker = setInterval(() => {
                if (tick > 30)
                {
                    document.querySelector(".main-list-area").classList.add("inactive");
                }
                else
                {
                    document.querySelector(".main-list-area").classList.remove("inactive");
                    tick++;
                }
            }, 1000);

            optRS.add(function()
            {
                redrawHeader(document.querySelector(".header"));
                // dataProcess(lastData, false);
            });

            redrawHeader(document.querySelector(".header"));

            function onOverlayDataUpdate(e)
            {
                dataProcess(JSON.stringify({"msgtype":"CombatData", "msg":e}));
            }

            function personClassCheck(person, className, filter, matrix)
            {
                const e = document.querySelector(filter.replace(/%PERSON_LDASH%/ig, person.name.replace("'", "_")).replace(/%PERSON%/ig, person.name));
                if (matrix) e.classList.add(className);
                else e.classList.remove(className);
            }

            function buildElement(tag, className, parent)
            {
                const e = document.createElement(tag);
                if (className != "") e.classList.add(className);
                if (parent != undefined && parent != null) parent.append(e);
                return e;
            }

            function initCombatent(person)
            {
                var url_string = window.location.href;
                var url = new URL(url_string);
                var c = url.searchParams.get("name");
                /* elements */
                const 
                job_ico_class = "xiv-" + ((person.name == "Limit Break" && person.Job == "") ? "lb_icon" : person.Job),
                container          = buildElement("div", ""               , document.querySelector(".main-list-area")),
                    jobicon        = buildElement("div", "jobicon"        , container),
                    /**/cover      = buildElement("div", "cover"          , jobicon),
                    /**/icon       = buildElement(  "i", job_ico_class, jobicon),
                    tableitems     = buildElement("div", "tableitems"     , container),
                    /**/upline     = buildElement("div", "upline"         , tableitems),
                    /*    */name   = buildElement("div", "name"           , upline),
                    /**/downline   = buildElement("div", "downline"       , tableitems),
                    backguage      = buildElement("div", "guage"          , container),
                    /**/barprocess = buildElement("div", "guage-process"  , backguage),

                    /*    */encdps = buildElement("div", "encdps"         , upline),
                    /*    */maxhit = buildElement("div", "maxhit"         , downline);

                container.setAttribute("data-name", person.name.replace("'", "_"));
                encdps.setAttribute("title", "dps");

                if (c != undefined && c == "hide" && person.name != "YOU") name.style.filter = "blur(3px)";
            }

            function dataProcess(data, savework = true)
            {
                const raw = data;
                if (raw == null) return;
                tick = 0;
                let combatant = [];
                if (raw.msgtype == "CombatData")
                {
                    if (savework) lastData = JSON.parse(JSON.stringify(data));
                    let rawCombatants = raw.msg.Combatant;
                    let combatants = [];
                    let idx = 1;

                    for(const item of Object.values(rawCombatants)) combatants.push(item);
                    
                    let timer = raw.msg.Encounter.duration.replace(/(^0|:)/ig, "").padStart(5,"0");
                    _(".titlename>.title").innerHTML = raw.msg.Encounter.CurrentZoneName;
                    if (raw.msg.Encounter["encdps"] > 1000) _(".pdps").innerHTML = raw.msg.Encounter["ENCDPS-k"] + "k DPS";
                    else _(".pdps").innerHTML = raw.msg.Encounter["ENCDPS"] + " DPS";

                    if (raw.msg.Encounter["enchps"] > 1000) _(".phps").innerHTML = raw.msg.Encounter["ENCHPS-k"] + "k HPS";
                    else _(".phps").innerHTML = raw.msg.Encounter["ENCHPS"] + " HPS";

                    if (timer[0] == "0")
                    {
                        _(".hour-a").display("none");
                        _(".hour.sep").display("none");
                    }
                    else
                    {
                        _(".hour-a").display("block");
                        _(".hour.sep").display("block");
                    }
                    for(let i = timer.length - 1; i >= 0; i--)
                    {
                        _("."+timedisplay[i]).css({"clip-path":"url(#number_" + timer[i] + ")"});
                    }

                    combatants.sort((a, b) => b[sortkey] - a[sortkey]);

                    for(const combatant of combatants)
                    {
                        combatant.max = combatants[0][sortkey];
                        combatant.rank = idx++;
                    }

                    document.querySelectorAll(".main-list-area>div").forEach((elem) =>
                    {
                        if (combatants.filter(x => x.name.replace("'", "_") == elem.getAttribute("data-name")).length <= 0) elem.remove();
                    });

                    for(const person of combatants)
                    {
                        let container = document.querySelector(".main-list-area>div[data-name=\"" + person.name.replace("'", "_") + "\"]");
                        if (container == null)
                        {
                            initCombatent(person);
                        }

                        container = document.querySelector(".main-list-area>div[data-name=\"" + person.name.replace("'", "_") + "\"]");

                        let
                            cdhit = (person.CritDirectHitPct * 100),
                            dhit =  (person.DirectHitPct * 100),
                            chit =  (person["crithit%"] * 100),
                            rp = 100 - (person[sortkey] / person.max * 100);

                        personClassCheck(person, "tanker", ".main-list-area>div[data-name=\"%PERSON_LDASH%\"]", tanker.filter((x) => x == person.Job).length > 0);
                        personClassCheck(person, "healer", ".main-list-area>div[data-name=\"%PERSON_LDASH%\"]", healer.filter((x) => x == person.Job).length > 0);
                        personClassCheck(person, "me", ".main-list-area>div[data-name=\"%PERSON_LDASH%\"]", person.name == "YOU");


                        container.querySelector(".name").innerHTML = person.name;
                        container.setAttribute("class", person.Job.toLowerCase());
                        if (person.name == "YOU") container.setAttribute("class", "me");

                        container.setAttribute("style", "order:" + person.rank);
                        container.querySelector(".cover").setAttribute("style", "--cdhit:" + cdhit + "%; --dhit:" + ((cdhit / 2) + dhit) + "%; --chit:" + (dhit + chit) + "%");
                        container.querySelector(".tableitems").setAttribute("data-perc", (person[sortkeyperc] * 100).toFixed(0) + "%");
                        container.querySelector(".tableitems").setAttribute("style", "--perc:" + (rp > 90 ? 90 : rp) + "%");
                        container.querySelector(".guage").setAttribute("data-width", (rp > 90 ? 90 : rp));
                        container.querySelector(".guage-process").setAttribute("style", "right:" + ((rp > 90 ? 90 : rp)).toFixed(0) + "%; --dwidth:" + (100 - (rp > 90 ? 90 : rp)).toFixed(0) + "%");
                        container.querySelector(".jobicon>i").classList.add("xiv-" + ((person.name == "Limit Break" && person.Job == "") ? "lb_icon" : person.Job));
                        container.querySelector(".jobicon>i").setAttribute("title", "CDHit: " + cdhit + "%, DHit: " + dhit + "%, CHit: " + chit + "%");

                        container.querySelector(".encdps").innerHTML = person.encdps.toFixed(2);
                        container.querySelector(".maxhit").innerHTML = person.maxhit.split('-')[1];
                        container.querySelector(".maxhit").setAttribute("title", person.maxhit.split('-')[0]);
                    }
                }
            }
        </script>
    </body>
</html>